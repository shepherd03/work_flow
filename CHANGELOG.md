# 工作流编辑器 - 版本更新日志

## v2.0.0 - 循环体分支架构升级 🚀

**发布日期**: 2024年

### 🎯 重大功能升级

#### 1. **循环体分支系统** - 全新架构特性
- ✨ **可视化循环体连接**: 循环节点下方新增紫色连接点，支持连接子节点作为循环体
- 🔄 **智能处理策略**: 有子分支时优先使用分支逻辑，否则回退到表达式处理
- 📊 **循环上下文传递**: 子节点自动接收 `element`、`index`、`array` 循环变量
- 🎨 **差异化视觉设计**: 循环体连接使用紫色虚线，区别于普通数据流

#### 2. **架构优化** - 单父节点模式的扩展
- 🏗️ **类型系统扩展**: 新增 `LoopExecutionContext`、`NodeRelationType` 等类型
- 🔗 **连接关系增强**: 支持 `loopBodyNode` 指针，维护循环体关系
- ⚡ **执行引擎升级**: `WorkflowExecutor` 新增循环体分支执行能力
- 📋 **上下文系统**: `ExecutionContext` 新增循环体相关方法

#### 3. **用户体验提升** - 直观的循环工作流构建
- 💡 **智能提示**: 循环节点UI中显示分支连接说明和使用指南
- 🎯 **精确控制**: 支持四种循环类型（forEach、map、filter、reduce）+ 子分支
- 🔧 **灵活配置**: 表达式和分支两种处理方式，适应不同复杂度需求

### 🛠️ 技术实现详情

#### 新增类型定义
```typescript
// 循环执行上下文
export interface LoopExecutionContext {
    element: any;      // 当前循环元素
    index: number;     // 当前索引
    array: any[];      // 整个数组
    loopNodeId: string; // 循环节点ID
}

// 节点关系扩展
export interface Node<T> {
    loopBodyNode?: string; // 循环体子节点指针
    loopContext?: LoopExecutionContext; // 循环执行上下文
    isLoopBodyNode?: boolean; // 标记为循环体节点
}
```

#### 执行流程优化
1. **循环检测**: 自动检测是否有连接的循环体分支
2. **上下文创建**: 为每次循环创建独立的执行上下文
3. **分支执行**: 调用 `executeLoopBody` 执行子分支
4. **结果收集**: 根据循环类型收集和处理执行结果

#### UI组件更新
- **GeneralNodeWrapper**: 新增 `hasLoopBodyOutput` 属性支持
- **循环连接点**: 下方紫色连接点，样式差异化
- **连接识别**: 基于 `sourceHandle` 区分连接类型

### 📈 性能与兼容性

#### 性能提升
- **直接分支调用**: 避免复杂的表达式解析开销
- **上下文复用**: 高效的循环上下文管理
- **智能回退**: 无分支时自动使用表达式模式

#### 向后兼容
- ✅ **完全兼容**: 现有的表达式循环节点继续正常工作
- ✅ **渐进升级**: 用户可以选择性使用新的分支功能
- ✅ **数据保持**: 现有工作流数据结构保持不变

### 🎨 视觉设计更新

#### 连接样式系统
- **普通连接**: 蓝色实线，表示数据流
- **循环体连接**: 紫色虚线 + "循环体" 标签，表示循环分支
- **连接点设计**: 不同形状和颜色区分功能

#### 用户界面优化
- **循环节点面板**: 新增分支连接说明区域
- **状态指示**: 清晰显示是否有连接的循环体分支
- **使用提示**: 内置使用指南和最佳实践

### 🔍 使用示例

#### 基础循环体分支
```
数组数据节点 → 循环处理器 → 结果收集节点
                    ↓ (循环体分支)
                文本处理节点
```

#### 复杂数据处理流水线
```
开始节点 → 循环处理器（map模式） → 数学计算 → 结束节点
              ↓ (循环体分支)
          文本转换 → 条件判断 → 格式化
```

### 📚 开发指南

#### 创建循环体分支
1. 添加循环节点到画布
2. 从循环节点下方的紫色连接点拖拽连接
3. 连接到要执行的子节点
4. 子节点自动接收循环变量

#### 循环变量使用
- `element`: 当前处理的数组元素
- `index`: 元素在数组中的索引
- `array`: 完整的输入数组
- 特殊情况：reduce模式下element包含 `{element, accumulator}`

### 🐛 问题修复
- 修复了上游数据获取的复杂性问题
- 优化了单父节点架构的数据传递效率
- 改进了连接验证逻辑

### 🔮 未来规划
- 支持嵌套循环体分支
- 添加循环体条件中断功能
- 实现循环体分支的可视化调试
- 扩展更多循环模式和控制结构

---

## v1.0.0 - 基础工作流系统

### 初始功能
- 基础节点系统（数据、处理、控制）
- 单父节点架构
- 简化的数据流
- 表达式循环处理

---

**升级建议**: 强烈建议升级到 v2.0.0 以获得更强大的循环处理能力和更好的用户体验。该版本完全向后兼容，升级风险极低。

**技术支持**: 如有任何问题或建议，请通过 Issue 系统反馈。

**贡献者**: 感谢所有参与这次重大升级的开发者和测试人员！ 🙏
