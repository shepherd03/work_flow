# 智能工作流编辑器 - 架构设计文档

## 1. 项目概述

### 1.1 项目背景

本项目是一个基于React的可视化工作流编辑器，旨在提供一个灵活、可扩展的节点式编程平台。通过拖拽式界面，用户可以直观地构建复杂的数据处理流程，适用于数据分析、自动化任务、业务流程等场景。

### 1.2 核心特性

- **可视化编辑**: 基于ReactFlow的拖拽式节点编辑器
- **类型安全**: 完整的TypeScript类型定义
- **可扩展架构**: 插件化的节点模板系统
- **现代化UI**: 基于Ant Design和Tailwind CSS的响应式界面
- **实时验证**: 连接规则验证和节点数据验证

## 2. 技术架构

### 2.1 技术栈

```
前端框架: React 18.2.0
构建工具: Vite 5.2.8
类型系统: TypeScript 5.3.3
UI组件库: Ant Design 5.26.7
流程图引擎: ReactFlow 11.11.4
样式框架: Tailwind CSS 3.4.17
```

### 2.2 项目结构

```
work_flow/
├── src/
│   ├── components/          # UI组件
│   │   ├── default/        # 默认节点组件
│   │   ├── editor/         # 编辑器组件
│   │   └── general/        # 通用组件
│   ├── core/               # 核心逻辑
│   │   └── NodeRegistry.ts # 节点注册表
│   ├── nodeTemplates/      # 节点模板
│   ├── types/              # 类型定义
│   └── utils/              # 工具函数
```

## 3. 核心设计思路

### 3.1 节点模板系统 (NodeTemplate)

#### 设计理念

采用模板化设计，将节点的所有行为（渲染、执行、验证）封装在一个统一的接口中，实现高度的可扩展性和一致性。

#### 核心接口设计

```typescript
interface NodeTemplate<T> {
    metadata: NodeMetadata;           // 节点元数据
    initialData: () => T;            // 初始数据生成器
    getPorts: (nodeData: T) => {     // 端口配置
        input: SimplePort;
        output: SimplePort;
    };
    validate?: (nodeData: T) => {    // 数据验证
        isValid: boolean;
        errors: string[];
        warnings?: string[];
    };
    execute: (inputs: T, nodeData: T, context: ExecutionContext) => Promise<Record<string, any>>;
    renderInEditor?: (nodeData: T, isSelected: boolean, onDataChange: (data: T) => void, metadata: NodeMetadata) => ReactNode;
    behavior?: {                      // 行为配置
        resizable?: boolean;
        deletable?: boolean;
        copyable?: boolean;
        editable?: boolean;
        connectable?: boolean;
    };
    hooks?: {                        // 生命周期钩子
        onCreated?: (nodeId: string, nodeData: T) => void;
        onUpdated?: (nodeId: string, oldData: T, newData: T) => void;
        onDeleted?: (nodeId: string, nodeData: T) => void;
    };
}
```

#### 优势分析

1. **统一接口**: 所有节点遵循相同的模板结构
2. **类型安全**: 泛型设计确保类型安全
3. **可扩展性**: 通过模板注册机制实现动态扩展
4. **生命周期管理**: 完整的节点生命周期钩子

### 3.2 节点注册表系统 (NodeRegistry)

#### 设计目标

- 集中管理所有可用的节点类型
- 提供节点发现和注册机制
- 支持分类和搜索功能
- 事件驱动的节点生命周期管理

#### 核心功能

```typescript
class NodeRegistry {
    register(template: NodeTemplate): void;           // 注册节点模板
    get(type: string): NodeTemplate | undefined;      // 获取节点模板
    getAll(): NodeTemplate[];                         // 获取所有模板
    getByCategory(category: string): NodeTemplate[];  // 按分类获取
    search(query: string): NodeTemplate[];            // 搜索节点
    getCategories(): string[];                        // 获取所有分类
}
```

#### 设计亮点

1. **单例模式**: 全局唯一的注册表实例
2. **事件系统**: 支持节点事件监听和分发
3. **验证机制**: 注册时自动验证模板完整性
4. **统计功能**: 提供节点使用统计信息

### 3.3 简化的端口系统 (SimplePort)

#### 设计理念

采用简化的端口设计，每个节点只有一个输入端口和一个输出端口，降低复杂度。

#### 端口定义

```typescript
interface SimplePort {
    id: string;           // 端口ID
    dataType: string;     // 数据类型
    connectionRules?: PortConnectionRule; // 自定义连接规则
}

interface PortConnectionRule {
    allowedDataTypes?: string[];  // 允许的数据类型
    disallowedDataTypes?: string[]; // 禁止的数据类型
    customValidation?: (sourcePort: SimplePort, targetPort: SimplePort) => PortConnectionRuleResult;
}
```

#### 连接验证机制

1. **基础验证**: 数据类型匹配检查
2. **自定义规则**: 支持复杂的连接逻辑
3. **实时反馈**: 连接时提供即时验证反馈

## 4. 实现细节

### 4.1 工作流编辑器组件 (WorkflowEditor)

#### 核心功能

- **节点管理**: 基于ReactFlow的节点状态管理
- **连接处理**: 智能的连接验证和处理
- **拖拽支持**: 从节点面板拖拽创建节点
- **上下文菜单**: 右键菜单支持节点操作
- **元数据编辑**: 节点属性编辑模态框

#### 性能优化

```typescript
// 使用 useTransition 优化状态更新
const [isPending, startTransition] = useTransition();

// 使用 useMemo 缓存节点类型
const nodeTypes = useMemo(() => {
    const types: NodeTypes = {};
    const templates = nodeRegistry.getAll();
    // ... 构建节点类型映射
    return types;
}, [nodeTypesReady]);
```

### 4.2 数据节点模板实现

#### 已实现的数据类型

1. **字符串节点** (`data-string`): 文本数据处理
2. **数字节点** (`data-number`): 数值数据处理
3. **布尔值节点** (`data-boolean`): 逻辑值处理
4. **数组节点** (`data-array`): 数组数据处理
5. **对象节点** (`data-object`): 复杂对象处理

#### 模板特点

- **统一UI**: 使用GeneralNodeWrapper提供一致的界面
- **类型验证**: 每种数据类型都有相应的验证逻辑
- **JSON编辑**: 复杂数据类型支持JSON格式编辑
- **实时预览**: 显示数据类型的关键信息（长度、属性数量等）

### 4.3 UI设计规范

#### 设计原则

- **一致性**: 所有组件遵循Ant Design设计规范
- **简洁性**: 避免复杂的动画效果，保持界面简洁
- **适配性**: 专门适配ReactFlow的节点渲染环境
- **响应式**: 使用Tailwind CSS实现响应式设计

#### 组件层次

```
WorkflowEditor (主编辑器)
├── NodePalette (节点面板)
├── ReactFlow (流程图区域)
│   ├── DefaultNode (默认节点)
│   └── GeneralNodeWrapper (通用节点包装器)
├── ContextMenu (上下文菜单)
└── MetadataModal (元数据编辑)
```

## 5. 扩展性设计

### 5.1 节点扩展机制

#### 添加新节点类型

1. **创建模板**: 实现NodeTemplate接口
2. **注册模板**: 调用nodeRegistry.register()
3. **自动发现**: 编辑器自动识别新节点类型

#### 示例：添加HTTP请求节点

```typescript
const httpRequestTemplate: NodeTemplate<{
    url: string;
    method: 'GET' | 'POST' | 'PUT' | 'DELETE';
    headers: Record<string, string>;
}> = {
    metadata: {
        type: 'http-request',
        name: 'HTTP请求',
        description: '发送HTTP请求',
        category: '网络节点',
    },
    // ... 实现其他接口方法
};
```

### 5.2 自定义渲染支持

#### 渲染函数

- **renderInPalette**: 在节点面板中的渲染
- **renderInEditor**: 在编辑器中的渲染
- **自定义样式**: 支持节点级别的样式定制

### 5.3 执行引擎设计

#### 执行上下文

```typescript
interface ExecutionContext {
    workflowId: string;
    nodeId: string;
    variables: Record<string, any>;
    logger?: {
        info: (msg: string) => void;
        warn: (msg: string) => void;
        error: (msg: string) => void;
    };
    waitUntil?: (key: string, timeoutMs?: number) => Promise<any>;
    signal?: AbortSignal;
}
```

## 6. 未来规划

### 6.1 短期目标

- [ ] 实现更多基础节点类型（条件判断、循环、函数调用等）
- [ ] 添加工作流保存和加载功能
- [ ] 实现工作流执行引擎
- [ ] 添加节点分组和折叠功能

### 6.2 中期目标

- [ ] 支持自定义节点开发SDK
- [ ] 实现节点市场机制
- [ ] 添加工作流版本管理
- [ ] 支持并行执行和条件分支

### 6.3 长期目标

- [ ] 云端工作流存储和同步
- [ ] 实时协作编辑功能
- [ ] 工作流性能监控和分析
- [ ] AI辅助的节点推荐和优化

## 7. 技术亮点总结

### 7.1 架构优势

1. **模块化设计**: 清晰的模块分离和职责划分
2. **类型安全**: 完整的TypeScript类型系统
3. **可扩展性**: 插件化的节点模板系统
4. **性能优化**: React 18新特性的充分利用

### 7.2 用户体验

1. **直观操作**: 拖拽式的可视化编辑
2. **实时反馈**: 连接验证和错误提示
3. **响应式设计**: 适配不同屏幕尺寸
4. **一致性**: 统一的UI设计语言

### 7.3 开发体验

1. **开发友好**: 完善的类型定义和文档
2. **调试支持**: 丰富的日志和错误处理
3. **测试友好**: 模块化的设计便于单元测试
4. **维护性**: 清晰的代码结构和注释

## 8. 总结

本项目采用现代化的前端技术栈，通过精心设计的架构实现了高度可扩展的工作流编辑器。核心的节点模板系统和注册表机制为后续功能扩展奠定了坚实基础，而简化的端口设计降低了使用门槛，提高了开发效率。

项目目前已完成基础框架搭建和核心功能实现，为后续的功能扩展和性能优化提供了良好的起点。
